<!DOCTYPE html>
<html>
<head>
    <title>Starbridge Helpdesk</title>
    <link rel="stylesheet" href="./Content/normalize.css">
    <link rel="stylesheet" href="./Content/style.css">
</head>
<body>
    <div class="login-wrapper">
        <div class="login-box">
            <div class="login-form">
                <input id="displayname" placeholder="username" type="text" />
                <button type="submit" class="login-button">Enter chat</button>
            </div>
        </div>
    </div>

    <div class="content-wrapper">
        <div class="header">
            <div>
                <span>Starbridges</span>
                <span>Helpdesk</span>
            </div>
            <div class="username"></div>
        </div>

        <div class="main">
            <div class="h-main"></div>
            <div class="content">
                <div id="chats"></div>
                <div id="users"></div>
            </div>
            <div class="message-box">
                <textarea id="message"></textarea>
                <button type="submit" id="sendmessage">Send</button>
            </div>
        </div>
    </div>

    <input id="hdId" type="hidden" />
    <input id="hdUsername" type="hidden" />

    <!--Script references. -->

    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-1.12.4.min.js"></script>
    <script src="Scripts//jquery-ui-1.12.1.min.js"></script>

    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.1.2.min.js"></script>

    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/hubs"></script>

    <!--Add script to update the page and send messages.-->
    <script type="text/javascript">
        $(function () {
            // Declare a proxy to reference the hub.
            var chat = $.connection.chatHub;

            // Start the connection.
            $.connection.hub.start().done(function () {
                $('#sendmessage').click(function () {
                    var time = new Date();
                    var timeString = "(" + time.getHours() + ":" + time.getMinutes() + ":" + time.getSeconds() + ")";
                    // Call the Send method on the hub.
                    chat.server.send($('#displayname').val(), $('#message').val(), timeString);
                    // Clear text box and reset focus for next comment.
                    $('#message').val('').focus();
                });

                $("#message").keypress(function (e) {
                    if (e.which == 13) {
                        $("#sendmessage").click();
                    }
                });
            });

            // Create a function that the hub can call to broadcast messages.
            chat.client.broadcastMessage = function (name, message, time) {
                // Html encode display name and message.
                var encodedName = $('<div />').text(name).html();
                var encodedMsg = $('<div />').text(message).html();
                // Add the message to the page.
                $('#chats').append('<span><strong>' + encodedName
                    + '</strong>:&nbsp;&nbsp;' + encodedMsg + " " + time + '</span><br>');
                //$('#chats').scrollTop = $('#chats').scrollHeight;
                var height = $('#chats')[0].scrollHeight;
                $('#chats').scrollTop(height);
            };

            $('.login-button').click((event) => {
                var name = $('#displayname').val()
                if (name != "") {
                    chat.server.getMessages();
                    $('#hdUsername').val(name);
                    chat.server.getId().done(function (result) {
                        $('#hdId').val(result);
                    });
                    chat.server.connect(name);
                    $('.login-wrapper').hide();
                    $('.username').text(name);
                }
            });

            // Set Date
            var days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            var d = new Date();
            $('.h-main').text(days[d.getDay()] + ", " + d.getDate() + " " + months[d.getMonth()] + " " + d.getFullYear());

            // Set initial focus to message input box.
            $('#message').focus();

            $("#displayname").keypress(function (e) {
                if (e.which == 13) {
                    $(".login-button").click();
                }
            });

            chat.client.onConnected = function (users) {
                for (user in users) {
                    var selector = '[id="' + user + '"]';
                    var tag = document.querySelector(selector);
                    if (tag == null) {
                        $('#users').append('<p data-event="false" id="' + user + '"' + '><strong>' + users[user]
                            + '</strong></p>');
                    }
                }
                $('[id="' + $('#hdId').val() + '"]').css("color", "gray");
            }

            chat.client.makePrivateChatWindow = function (users) {
                for (user in users) {
                    if (user != $('#hdId').val()) {
                        var selector = '[id="' + user + '"]';
                        if ($(selector).attr("data-event") == "false") {
                            $(selector).dblclick(() => {
                                console.log($('#hdUsername').val() + " connected to " + $(selector).text());
                                openPrivateChatWindow($('#hdId').val(), $(selector).attr("id"), $(selector).text());
                            })
                            $(selector).attr("data-event", true);
                        }
                    }
                }
            }

            function openPrivateChatWindow(idFrom, toId, toName) {
                var div = '<div id="' + toId + '" class="ui-widget-content draggable" rel="0">' +
                    '<div class="headerP">' +
                    '<div  style="float:right;">' +
                    '<a id="closeWindow" style="cursor:pointer;">x</a>' +
                    '</div>' +

                    '<span class="selText" rel="0">' + toName + '</span>' +
                    '</div>' +
                    '<div id="divMessage" class="messageArea">' +

                    '</div>' +
                    '<div class="buttonBar">' +
                    '<input id="txtPrivateMessage" class="msgText" type="text"   />' +
                    '<input id="btnSendMessage" class="submitButton button" type="button" value="Send"   />' +
                    '</div>' +
                    '</div>';

                var $div = $(div);
                AddDivToContainer($div);

                // CLOSE WINDOW
                $div.find('#closeWindow').click(function () {
                    $('#' + toId).remove();
                });


                // Send Button event
                $div.find("#btnSendMessage").click(function () {

                    $textBox = $div.find("#txtPrivateMessage");
                    var msg = $textBox.val();
                    if (msg.length > 0) {
                        var nameFrom = $('#hdUsername').val();
                        chat.server.sendPrivateMessage(toId, idFrom, nameFrom, msg);
                        $textBox.val('');
                    }
                });

                // Text Box event
                $div.find("#txtPrivateMessage").keypress(function (e) {
                    if (e.which == 13) {
                        $div.find("#btnSendMessage").click();
                    }
                });
            }

            function AddDivToContainer($div) {
                $('.content-wrapper').prepend($div);
                $div.draggable({
                    handle: ".headerP",
                    stop: function () {
                    }
                });
            }

            chat.client.sendPrivateMessage = function (toId, idFrom, nameFrom, msg) {
                var tag = document.querySelector('.ui-widget-content');
                if (tag == null) {
                    openPrivateChatWindow(toId, idFrom, nameFrom);
                }
                // Html encode display name and message.
                var encodedName = $('<div />').text(nameFrom).html();
                var encodedMsg = $('<div />').text(msg).html();
                // Add the message to the page.
                var time = new Date();
                var timeString = "(" + time.getHours() + ":" + time.getMinutes() + ":" + time.getSeconds() + ")";
                $('#divMessage').append('<span><strong>' + encodedName
                    + '</strong>:&nbsp;&nbsp;' + encodedMsg + " " + timeString + '</span><br>');
                var height = $('#divMessage')[0].scrollHeight;
                $('#divMessage').scrollTop(height);
            };

            chat.client.getMessages = function (result) {
                if (result.length > 0) {
                    for (var msgInfo of result) {
                        $('#chats').append('<span><strong>' + msgInfo[0]
                            + '</strong>:&nbsp;&nbsp;' + msgInfo[1] + " " + msgInfo[2] + '</span><br>');
                    }
                }
            }

            chat.client.onDisconnected = function (id) {
                var selector = '[id="' + id + '"]';
                $(selector).remove();
            }
        });
    </script>
</body>
</html>